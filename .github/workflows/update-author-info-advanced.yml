name: Advanced Author Information Updater

on:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  TARGET_AUTHOR_NAME: "shuiro"
  TARGET_AUTHOR_EMAIL: "<shuirong1997@icloud.com>"

jobs:
  update-author-info:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: write
      pull-requests: write
    
    steps:
    - name: ğŸ›‘ Security Check
      run: |
        echo "ğŸ” Security Check: Verifying repository and permissions"
        echo "Repository: ${{ github.repository }}"
        echo "Actor: ${{ github.actor }}"
        echo "PR Author: ${{ github.event.pull_request.user.login }}"
        
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install git-filter-repo
        
    - name: âš™ï¸ Configure Git
      run: |
        git config --global user.name "${{ env.TARGET_AUTHOR_NAME }}"
        git config --global user.email "${{ env.TARGET_AUTHOR_EMAIL }}"
        git config --global init.defaultBranch main
        
    - name: ğŸ” Analyze repository state
      id: analyze
      run: |
        echo "=== Repository Analysis ==="
        
        # æ£€æŸ¥å½“å‰åˆ†æ”¯
        CURRENT_BRANCH=$(git branch --show-current)
        echo "Current branch: $CURRENT_BRANCH"
        echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
        
        # ç»Ÿè®¡éœ€è¦ä¿®æ”¹çš„æäº¤
        COMMITS_TO_UPDATE=$(git log --pretty=format:"%an <%ae>" | grep -v "${{ env.TARGET_AUTHOR_NAME }}" | wc -l || echo "0")
        echo "Commits needing update: $COMMITS_TO_UPDATE"
        echo "commits_to_update=$COMMITS_TO_UPDATE" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æœ€è¿‘çš„æäº¤ä¿¡æ¯
        echo "=== Recent Commits ==="
        git log --oneline -10 --pretty=format:"%h %s (%an <%ae>)"
        
        # è®¾ç½®æ˜¯å¦éœ€è¦æ›´æ–°çš„æ ‡å¿—
        if [ "$COMMITS_TO_UPDATE" -gt "0" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "âœ… Found $COMMITS_TO_UPDATE commits that need author update"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ All commits already have the correct author information"
        fi
        
    - name: ğŸ”„ Update author information
      if: steps.analyze.outputs.needs_update == 'true'
      run: |
        echo "ğŸš€ Starting author information update process..."
        
        # åˆ›å»ºå¤‡ä»½åˆ†æ”¯
        BACKUP_BRANCH="backup-before-filter-$(date +%Y%m%d-%H%M%S)"
        git branch "$BACKUP_BRANCH"
        echo "ğŸ“‹ Created backup branch: $BACKUP_BRANCH"
        
        # æ‰§è¡Œ git-filter-repo
        echo "ğŸ”§ Applying git-filter-repo..."
        git filter-repo --force \
          --commit-callback '
        commit.author_name = b"${{ env.TARGET_AUTHOR_NAME }}"
        commit.author_email = b"${{ env.TARGET_AUTHOR_EMAIL }}"  
        commit.committer_name = b"${{ env.TARGET_AUTHOR_NAME }}"
        commit.committer_email = b"${{ env.TARGET_AUTHOR_EMAIL }}"
        ' || {
          echo "âŒ git-filter-repo failed"
          exit 1
        }
        
        echo "âœ… Author information updated successfully"
        
        # éªŒè¯æ›´æ–°ç»“æœ
        echo "=== Updated Commits ==="
        git log --oneline -10 --pretty=format:"%h %s (%an <%ae>)"
        
    - name: ğŸ”— Re-add remote origin
      if: steps.analyze.outputs.needs_update == 'true'
      run: |
        echo "ğŸ”— Re-adding remote origin..."
        git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git remote -v
        
    - name: ğŸ“¤ Push updated history
      if: steps.analyze.outputs.needs_update == 'true'
      run: |
        echo "ğŸ“¤ Pushing updated history to main branch..."
        
        # ä½¿ç”¨ --force-with-lease è¿›è¡Œå®‰å…¨çš„å¼ºåˆ¶æ¨é€
        git push --force-with-lease origin main || {
          echo "âŒ Force push failed - this might indicate concurrent changes"
          echo "ğŸ”„ Trying to fetch and retry..."
          git fetch origin main
          git push --force origin main
        }
        
        echo "âœ… Changes pushed successfully"
        
    - name: ğŸ“Š Generate summary
      run: |
        echo "## ğŸ“‹ Author Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.analyze.outputs.needs_update }}" == "true" ]; then
          echo "âœ… **Status**: Author information updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ˆ **Commits Updated**: ${{ steps.analyze.outputs.commits_to_update }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Status**: No updates needed - all commits already have correct author" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Target Author Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Name**: ${{ env.TARGET_AUTHOR_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Email**: ${{ env.TARGET_AUTHOR_EMAIL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ Recent Commits (After Update)" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        git log --oneline -5 --pretty=format:"%h %s (%an <%ae>)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ’¬ Comment on PR
      if: steps.analyze.outputs.needs_update == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `
          ## ğŸ‰ Author Information Updated Successfully
          
          This PR has been merged and the author information has been automatically updated:
          
          - **Updated Commits**: ${{ steps.analyze.outputs.commits_to_update }}
          - **Target Author**: ${{ env.TARGET_AUTHOR_NAME }} <${{ env.TARGET_AUTHOR_EMAIL }}>
          
          All commit history now reflects the standardized author information.
          
          ---
          *This comment was automatically generated by the Author Update workflow.*
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: ğŸš¨ Notify on failure  
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `
          ## âš ï¸ Author Information Update Failed
          
          The automatic author information update process encountered an error after this PR was merged.
          
          **Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.**
          
          Manual intervention may be required.
          
          ---
          *This comment was automatically generated by the Author Update workflow.*
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 